<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NER</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-gray-100 flex justify-center items-start min-h-screen">

  <!-- Config Button  -->
  <div class="absolute top-4 left-4 z-20">
    <a href="{{ url_for('config') }}" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded shadow-lg">
      Config
    </a>
  </div>

    <!-- Form for entering text and submitting to NER -->
  <div class="bg-white shadow-md rounded-lg p-8 max-w-2xl w-full">
    <form id="config-form" action="/" method="POST">
      <div class="mb-4">
        <textarea id="user-text" name="text" class="w-full p-2 border border-gray-300 rounded" rows="4" placeholder="Enter text here">{{ raw_text }}</textarea>
      </div>

      <!-- Hidden inputs that get populated based on which button is clicked -->
      <input type="hidden" id="hidden-url" name="url" value="">
      <input type="hidden" id="hidden-extra" name="extra_args" value="">

      <!-- Buttons from configs -->
      <div class="mb-4">
        <h2 class="text-xl font-semibold">Run NER</h2>
        <div id="config-buttons" class="mt-4 flex flex-wrap gap-4">
          {% for button in configs %}
            <button
              type="button"
              class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
              data-url="{{ button['url'] }}"
              data-extra='{{ button.get("extra_args", "") | tojson }}'
              onclick="submitWithConfig(this)"
            >
              {{ button['button_name'] }}
            </button>
          {% endfor %}
        </div>
      </div>
    </form>

    <!-- Highlighted NER text -->
    {% if highlighted_text %}
      <div class="mt-6 p-4 border border-gray-300 rounded bg-gray-50 shadow-inner">
        <h2 class="text-xl font-semibold">NER result</h2>
        <div id="highlighted-text" class="mt-4" style="white-space: pre-wrap;">{{ highlighted_text | safe }}</div>
      </div>
    {% endif %}

    <!-- Legend (fixed on the right) -->
    {% if type_colors %}
      <div class="legend-container">
        <h2 class="text-xl font-semibold mb-4">Entities</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          {% for type_name, color in type_colors.items() %}
            <div class="legend-item">
              <div style="background-color: {{ color }};"></div>
              <span>{{ type_name }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}


    {% if model_names %}
      <div class="mt-16">
        <h2 class="text-2xl font-bold mb-3">Result Comparison</h2>
        <p class="text-sm text-gray-500 mb-4">
          One column per model in your config. Each column lists all cached entities (alphabetically).
          Models without a cached result show dashes. No new requests are made.
        </p>

        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                {% for m in model_names %}
                  <th class="py-2 px-3 text-left font-semibold border-b border-gray-200">{{ m }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {# Find the tallest column so we render ALL rows #}
              {% set ns = namespace(maxlen=0) %}
              {% for m in model_names %}
                {% set l = (entity_columns.get(m) or [])|length %}
                {% if l > ns.maxlen %}{% set ns.maxlen = l %}{% endif %}
              {% endfor %}

              {% for i in range(ns.maxlen) %}
                <tr class="border-b border-gray-100">
                  {% for m in model_names %}
                    {% set items = entity_columns.get(m) or [] %}
                    <td class="py-2 px-3 align-top">
                      {% if i < items|length %}
                        {% set ent = items[i][0] %}
                        {% set label = items[i][1] %}
                        <div class="leading-snug">
                          <span class="font-medium">{{ ent }}</span>
                          <span class="text-gray-500 text-xs"> — {{ label }}</span>
                        </div>
                      {% else %}
                        <span class="text-gray-300">—</span>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>


<script>
  function submitWithConfig(btn) {
    // Grab the per-button values
    const url = btn.dataset.url || '';
    // data-extra is JSON-encoded by Jinja's tojson; parse then re-stringify to send a clean string
    let extra = '';
    try {
      const parsed = JSON.parse(btn.dataset.extra || '""');
      // If parsed is an object/array, send JSON; if string, send as-is
      extra = (typeof parsed === 'string') ? parsed : JSON.stringify(parsed);
    } catch (_) {
      extra = btn.dataset.extra || '';
    }

    // Populate hidden inputs
    document.getElementById('hidden-url').value = url;
    document.getElementById('hidden-extra').value = extra;

    // Submit the form
    document.getElementById('config-form').submit();
  }
</script>

<!-- Put this right before </body> -->
<div id="app-tooltip" style="
  position: fixed;
  z-index: 2147483647;
  pointer-events: none;
  background: rgba(17,24,39,0.95); /* gray-900-ish */
  color: white;
  padding: 6px 8px;
  border-radius: 6px;
  font-size: 0.875rem;
  line-height: 1.2;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  transform: translate(-50%, -125%);
  display: none;
  max-width: 60vw;
  word-wrap: break-word;
"></div>

<script>
  (function () {
    const tooltip = document.getElementById('app-tooltip');

    function showTooltip(text) {
      tooltip.textContent = text || '';
      tooltip.style.display = text ? 'block' : 'none';
    }

    function hideTooltip() {
      tooltip.style.display = 'none';
    }

    function positionTooltip(e) {
      const offset = 14; // px away from cursor
      let x = e.clientX + offset;
      let y = e.clientY - offset;

      // keep inside viewport
      const rect = tooltip.getBoundingClientRect();
      const vw = document.documentElement.clientWidth;
      const vh = document.documentElement.clientHeight;

      if (x + rect.width > vw - 8) x = vw - rect.width - 8;
      if (y - rect.height < 0) y = e.clientY + offset; // flip below mouse if needed

      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    document.addEventListener('mouseover', (e) => {
      const el = e.target.closest('.ner-highlight');  // was .highlight
      if (!el) return;
      const txt = el.getAttribute('aria-label') || '';
      if (!txt) return;
      showTooltip(txt);
      positionTooltip(e);
    });

    document.addEventListener('mousemove', (e) => {
      if (tooltip.style.display === 'block') {
        positionTooltip(e);
      }
    });

    document.addEventListener('mouseout', (e) => {
      const el = e.target.closest('.ner-highlight');  // was .highlight
      if (!el) return;
      const related = e.relatedTarget && e.relatedTarget.closest
        ? e.relatedTarget.closest('.ner-highlight')  // was .highlight
        : null;
      if (!related) hideTooltip();
    });

    // Safety: hide on scroll or escape
    document.addEventListener('scroll', hideTooltip, true);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideTooltip(); });
  })();
</script>

</body>
</html>
